rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }

    // Utility functions

    function getRolePermissions(role) {
      return get(/databases/$(database)/documents/userRoles/$(role)).data.permissions;
    }

    function getUserOrg() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.org;
    }

    function getUserOrgRole(orgId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgs[orgId].role;
    }

    function isUserAuthenticated() {
      return request.auth != null
    }

    function isUserInResourceOrg() {
      return resource.data.org == getUserOrg();
    }

    function isUserOrgOwner() {
      return resource.id == getUserOrg();
    }

    function isUserOrgAdmin() {
      let userRole = getUserOrgRole();
      return "updateOrg" in getRolePermissions(userRole);
    }

    // Forms

    match /forms/{formId} {
      function doesUserRoleHaveViewFormPermissions() {
        let userRole = getUserOrgRole(request.resource.data.orgId);
        return "viewForm" in getRolePermissions(userRole);
      }

      function doesUserRoleHaveUpdateFormPermissions() {
        let userRole = getUserOrgRole(request.resource.data.orgId);
        return "updateForm" in getRolePermissions(userRole);
      }

      function doesUserRoleHaveDeleteFormPermissions() {
        let userRole = getUserOrgRole(request.resource.data.orgId);
        return "deleteForm" in getRolePermissions(userRole);
      }

      function doesUserRoleHaveCreateFormPermissions() {
        let userRole = getUserOrgRole(request.resource.data.orgId);
        return "createForm" in getRolePermissions(userRole);
      }

      function containsProtectedFormKeys() {
        return request.resource.data.keys().hasAny(["id", "createdAt", "updatedAt"]);
      }

      allow get, list: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveViewFormPermissions();
      allow create: if isUserAuthenticated() && doesUserRoleHaveCreateFormPermissions() && !containsProtectedFormKeys();
      allow update: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveUpdateFormPermissions() && !containsProtectedFormKeys();
      allow delete: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveDeleteFormPermissions();

      // Output entities

      match /outputEntities/{outputEntityId} {
        function doesUserRoleHaveViewOutputEntityPermissions() {
          let userRole = getUserOrgRole();
          return "viewOutputEntity" in getRolePermissions(userRole);
        }

        function doesUserRoleHaveUpdateOutputEntityPermissions() {
          let userRole = getUserOrgRole();
          return "updateOutputEntity" in getRolePermissions(userRole);
        }

        function doesUserRoleHaveDeleteOutputEntityPermissions() {
          let userRole = getUserOrgRole();
          return "deleteOutputEntity" in getRolePermissions(userRole);
        }

        function doesUserRoleHaveCreateOutputEntityPermissions() {
          let userRole = getUserOrgRole();
          return "createOutputEntity" in getRolePermissions(userRole);
        }

        function containsProtectedOutputEntityKeys() {
          return request.resource.data.keys().hasAny(["id", "createdAt", "updatedAt"]);
        }

        allow get, list: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveViewOutputEntityPermissions();
        allow create: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveCreateOutputEntityPermissions() && !containsProtectedOutputEntityKeys();
        allow update: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveUpdateOutputEntityPermissions() && !containsProtectedOutputEntityKeys();
        allow delete: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveDeleteOutputEntityPermissions();
      }

      // Entries

      match /entries/{entryId} {
        function doesUserRoleHaveViewEntryPermissions() {
          let userRole = getUserOrgRole();
          return "viewEntry" in getRolePermissions(userRole);
        }

        function doesUserRoleHaveUpdateEntryPermissions() {
          let userRole = getUserOrgRole();
          return "updateEntry" in getRolePermissions(userRole);
        }

        function doesUserRoleHaveDeleteEntryPermissions() {
          let userRole = getUserOrgRole();
          return "deleteEntry" in getRolePermissions(userRole);
        }

        function doesUserRoleHaveCreateEntryPermissions() {
          let userRole = getUserOrgRole();
          return "createEntry" in getRolePermissions(userRole);
        }

        function containsProtectedEntryKeys() {
          return request.resource.data.keys().hasAny(["id", "createdAt", "updatedAt"]);
        }

        allow get, list: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveViewEntryPermissions();
        allow create: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveCreateEntryPermissions() && !containsProtectedEntryKeys();
        allow update: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveUpdateEntryPermissions() && !containsProtectedEntryKeys();
        allow delete: if isUserAuthenticated() && isUserInResourceOrg() && doesUserRoleHaveDeleteEntryPermissions();
      }
    }

    // Organisations

    match /organisations/{orgId} {
      function isUserInCurrentOrg() {
        return orgId == getUserOrg();
      }

      function doesUserRoleHaveViewOrgPermissions() {
        let userRole = getUserOrgRole();
        return "viewOrg" in getRolePermissions(userRole);
      }

      function doesUserRoleHaveUpdateOrgPermissions() {
        let userRole = getUserOrgRole();
        return "updateOrg" in getRolePermissions(userRole);
      }

      function doesUserRoleHaveDeleteOrgPermissions() {
        let userRole = getUserOrgRole();
        return "deleteOrg" in getRolePermissions(userRole);
      }

      function doesUserRoleHaveCreateOrgPermissions() {
        let userRole = getUserOrgRole();
        return "createOrg" in getRolePermissions(userRole);
      }

      function containsProtectedOrgKeys() {
        return request.resource.data.keys().hasAny(["id", "members", "createdAt", "updatedAt"]);
      }

      allow get, list: if isUserAuthenticated() && isUserInCurrentOrg() && doesUserRoleHaveViewOrgPermissions();
      allow create: if null;
      allow update: if isUserAuthenticated() && isUserInCurrentOrg() && doesUserRoleHaveUpdateOrgPermissions() && !containsProtectedOrgKeys();
      allow delete: if isUserAuthenticated() && isUserInCurrentOrg() && doesUserRoleHaveDeleteOrgPermissions();
    }

    // User

    match /users/{userId} {
      allow get: if isUserAuthenticated() && request.auth.uid == userId;
      allow create, list: if null;
      allow update: if null;
      allow delete: if isUserAuthenticated() && request.auth.uid == userId;
    }
  }
}